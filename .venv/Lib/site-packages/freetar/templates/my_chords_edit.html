{% extends "base.html" %}
{% block content %}
<h2>Edit chord library</h2>

<button id="add-group" class="btn btn-sm btn-primary mb-3">Add group</button>
<button id="save" class="btn btn-sm btn-success mb-3 ms-2">Save</button>

<div id="groups-root" class="row g-3" data-initial='{{ groups_json|tojson|safe }}'>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const root = document.getElementById('groups-root');
    const initial = JSON.parse(root.dataset.initial || "[]");

    function render() {
        root.innerHTML = "";
        initial.forEach((group, gi) => {
            const col = document.createElement('div');
            col.className = "col-md-4";
            col.innerHTML = `
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <input class="form-control form-control-sm group-name" value="${group.group || ''}">
            <button class="btn btn-sm btn-outline-danger ms-2 remove-group">&times;</button>
          </div>
          <div class="card-body chord-list" data-gi="${gi}"></div>
          <div class="card-footer">
            <button class="btn btn-sm btn-outline-primary add-chord">Add chord</button>
          </div>
        </div>`;
            root.appendChild(col);
            const list = col.querySelector('.chord-list');
            group.chords.forEach((ch, ci) => {
                const card = document.createElement('div');
                card.className = "card mb-2";
                card.innerHTML = `
          <div class="card-body py-2 d-flex gap-2 align-items-center">
            <input class="form-control form-control-sm chord-name" style="max-width: 40%;" value="${ch.name}">
            <input class="form-control form-control-sm chord-shape" value="${ch.shape}">
            <button class="btn btn-sm btn-outline-danger remove-chord">&times;</button>
          </div>`;
                card.dataset.ci = ci;
                list.appendChild(card);
            });

            // per-group sortable
            Sortable.create(list, {
                group: 'chords',
                animation: 150,
                onEnd: rebuildFromDOM
            });

            col.querySelector('.add-chord').onclick = () => {
                group.chords.push({ name: "New", shape: "x00000" });
                render();
            };
            col.querySelector('.remove-group').onclick = () => {
                initial.splice(gi, 1);
                render();
            };
        });
    }

    function rebuildFromDOM() {
        const newData = [];
        root.querySelectorAll('.card .chord-list').forEach((listEl) => {
            const groupCard = listEl.closest('.card');
            const groupName = groupCard.querySelector('.group-name').value.trim() || "Group";
            const chords = [];
            listEl.querySelectorAll('.card').forEach((cardEl) => {
                chords.push({
                    name: cardEl.querySelector('.chord-name').value.trim(),
                    shape: cardEl.querySelector('.chord-shape').value.trim()
                });
            });
            newData.push({ group: groupName, chords });
        });
        initial.splice(0, initial.length, ...newData);
    }

    document.getElementById('add-group').onclick = () => {
        initial.push({ group: "New group", chords: [] });
        render();
    };

    document.getElementById('save').onclick = async () => {
        rebuildFromDOM();
        await fetch("{{ url_for('my_chords_edit') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(initial)
        });
        alert("Saved");
    };

    // sync edits into data on input change
    root.addEventListener('input', (e) => {
        if (e.target.classList.contains('group-name') ||
            e.target.classList.contains('chord-name') ||
            e.target.classList.contains('chord-shape')) {
            rebuildFromDOM();
        }
    });

    render();
</script>
{% endblock %}