{% extends "base.html" %}

{% block content %}

<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
<link rel="stylesheet" href="{{ url_for('static', filename='my-chords.css') }}">
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&family=Noto+Sans+Symbols+2&display=swap">


<h2 class="mb-3">Chord Library</h2>

<div class="d-flex mb-3 gap-2"> <button id="show-import-chords" class="btn btn-sm btn-primary">Import Chords</button>
    <button id="add-group" class="btn btn-sm btn-primary">Add group</button> <span id="undo-redo-wrap"
        style="margin-left:auto; display:flex; gap:0.5rem; align-items:center;"></span>
</div>

{% if groups|length == 0 %}

<p id="empty-msg">No chords defined yet.</p> {% else %} <p id="empty-msg" style="display:none;">No chords defined yet.
</p> {% endif %}

<div id="import-chords-area" style="display: none; margin-bottom: 1rem;">
    <label for="import-chords-input" class="form-label">Paste multiple chords (one per line):</label>
    <textarea id="import-chords-input" class="form-control mb-2" rows="5"
        style="resize: vertical; min-height: 5em; max-height: 15em;"></textarea>
    <div>
        <button id="import-chords-btn" class="btn btn-primary btn-sm">Import</button>
        <button id="cancel-import-chords" class="btn btn-outline-secondary btn-sm">Cancel</button>
    </div>
    <div class="form-text">Format: <code>Label, shape[, group]</code>. Example: <code>Am, x02210, Open</code></div>
</div>
<div id="groups-root">
    {% for group in groups %}
    <div class="group mb-4">
        <div class="d-flex align-items-center mb-2 group-header gap-2">
            <span class="material-icons-outlined group-handle"
                style="cursor: move; font-size: 18px;">drag_indicator</span>
            <input class="form-control form-control-sm group-name" value="{{ group.group }}">

            <button type="button" class="btn btn-sm btn-primary add-chord">Add chord</button>
            <button type="button" class="btn btn-sm btn-primary delete-chords">Delete Chords</button>
            <button type="button" class="btn btn-sm btn-primary delete-group">Delete Group</button>
        </div>

        <div class="d-grid chord-grid"
            style="row-gap: 0.5rem; column-gap: 2rem; grid-template-columns: repeat(auto-fill, minmax(min(120px, 100%), 1fr));">
            {% for chord in group.chords %}
            {% set diag = chord.diagram %}
            <div class="text-center chord-card mb-3">
                <div class="d-flex align-items-center justify-content-between mb-1 position-relative">
                    <span class="material-icons-outlined chord-handle"
                        style="cursor: move; font-size: 18px;">drag_indicator</span>
                    <span class="chord-title flex-grow-1 text-truncate mx-1">{{ chord.name }}</span>
                    <span class="material-icons-outlined chord-edit"
                        style="cursor: pointer; font-size: 18px;">edit</span>
                    <button class="delete-chord-btn" type="button" title="Delete chord" tabindex="-1"
                        style="display:none;">&#8722;</button>
                </div>

                <div class="chord-edit-fields mb-2" style="display: none;">
                    <input class="form-control form-control-sm mb-1 chord-name-input" value="{{ chord.name }}">
                    <input class="form-control form-control-sm chord-shape-input" value="{{ chord.shape }}">
                </div>

                <table class="chord-diagram">
                    <thead>
                        <tr>
                            <th class="chord-header-spacer"></th>
                            {% for x in diag.header %}
                            {# positional class for nut clipping #}
                            {% set pos_class = 'string-col' %}
                            {% if loop.first %}
                            {% set pos_class = pos_class + ' string-left' %}
                            {% elif loop.last %}
                            {% set pos_class = pos_class + ' string-right' %}
                            {% endif %}

                            {# visual class based on symbol #}
                            {% if x in ['x', 'X'] %}
                            {% set cls = 'chord-header-muted ' + pos_class %}
                            {% elif x in ['o', 'O'] %}
                            {% set cls = 'chord-header-open ' + pos_class %}
                            {% else %}
                            {% set cls = 'chord-header-fret ' + pos_class %}
                            {% endif %}

                            <th class="{{ cls }}">
                                {% if x in ['x', 'X', 'o', 'O'] %}
                                <span class="chord-header-label">{{ x }}</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in diag.rows %}
                        <tr>
                            <td class="chord-fret-label">{{ row.fret }}</td>
                            {% for mark in row.strings %}
                            <td
                                class="chord-string-cell{% if loop.first %} string-left{% elif loop.last %} string-right{% endif %}">
                                <div class="chord-dot-wrap">
                                    <div class="chord-dot {{ 'chord-dot-filled' if mark == 1 }}"></div>
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        <!-- Fretted numbers below diagram -->
                        <tr class="chord-footer-row">
                            <td class="chord-footer-spacer"></td>
                            {% for x in diag.header %}
                            <td class="chord-footer-cell">
                                {% if x not in ['x', 'X', 'o', 'O'] %}
                                <span class="chord-footer-label">{{ x }}</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

</div>

<!-- Delete Group Modal -->
<div class="modal" tabindex="-1" id="delete-group-modal"
    style="display:none; background:rgba(0,0,0,0.4); position:fixed; top:0; left:0; width:100vw; height:100vh; z-index:2000; align-items:center; justify-content:center;">
    <div style="background:white; padding:2rem; border-radius:8px; max-width:90vw; min-width:320px;">
        <h5 class="mb-3">Delete Group?</h5>
        <p>This will delete the entire group and all its chords.<br>Are you sure you want to proceed?</p>
        <div class="d-flex justify-content-end gap-2 mt-3">
            <button id="confirm-delete-group" class="btn btn-danger btn-sm">Yes, delete group</button>
            <button id="cancel-delete-group" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='vendor/morphdom-umd.min.js') }}"></script>
<script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script defer src="{{ url_for('static', filename='undoRedo.js') }}"></script>
<script defer src="{{ url_for('static', filename='chordDiagram.js') }}"></script>
<script>window.MY_CHORDS_EDIT_URL = "{{ url_for('my_chords_edit') }}";</script>
<script defer src="{{ url_for('static', filename='my-chords.page.js') }}"></script>

{% endblock %}