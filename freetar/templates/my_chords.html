{% extends "base.html" %}
<!-- Styled by freetar/static/my-chords.css (My Chords page) -->

{% block content %}

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
<link rel="stylesheet" href="{{ url_for('static', filename='my-chords.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='tooltips.css') }}">
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&family=Noto+Sans+Symbols+2&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@600&display=swap">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">


<style>
    /* Ensure quote-cards (text-only) display newlines correctly */
    .collection-text-card .chord-title {
        white-space: pre-wrap !important;
    }
</style>

<div class="page-title-group">
    {% if collection_id is defined %}
    <div class="page-breadcrumb text-muted small">
        <a href="{{ url_for('my_collections') }}" class="text-decoration-none">
            <span class="material-icons-outlined breadcrumb-icon">home</span>
            My Chords
        </a>
        <span class="mx-1">/</span>
        <span class="text-muted">{{ collection_group or 'Collection Group' }}</span>
    </div>

    {% endif %}

    <div class="d-flex align-items-center mb-3 page-title-row">
        <h2 class="page-title flex-grow-1">
            {% if collection_id is defined %}
            {{ collection_name }}
            {% else %}
            Chord Library
            {% endif %}
        </h2>
        <button id="show-import-chords" class="primary-button" data-tooltip="Import chords from pasted text"
            title="Import chords from pasted text" aria-expanded="false">
            Import Chords
        </button>
        <span id="undo-redo-wrap" class="d-flex align-items-center gap-2">
            <button type="button" class="primary-button" aria-label="Import chord library"
                data-tooltip="Import Chords from File" data-tooltip-src="Import Chords from File"
                title="Import Chords from File">
                <span class="material-icons-outlined" aria-hidden="true">file_upload</span>
            </button>
            <button type="button" class="primary-button toolbar-export" aria-label="Export chord library"
                data-tooltip="Export All Chords to File" data-tooltip-src="Export All Chords to File"
                title="Export All Chords to File">
                <span class="material-icons-outlined" aria-hidden="true">file_download</span>
            </button>
        </span>
        <div class="chord-settings-wrap">
            <button id="diagram-lock-toggle" type="button" class="lock-button" aria-label="Toggle diagram lock"
                aria-pressed="false" data-locked="false"
                data-tooltip="Diagram lock is OFF (diagram clicks edit immediately)"
                title="Diagram lock is OFF (diagram clicks edit immediately)">
                <span class="material-icons-outlined" aria-hidden="true">lock_open</span>
            </button>
            <button id="help-toggle" type="button" class="lock-button chord-settings-button" aria-label="Help"
                data-tooltip="Help" data-tooltip-src="Help" title="Help">
                <span class="material-icons-outlined"> help_outline </span>
            </button>
            <button id="chord-settings-toggle" type="button" class="lock-button chord-settings-button"
                aria-label="Chord layout settings" aria-expanded="false" data-tooltip="Chord layout settings"
                title="Chord layout settings">
                <span class="material-icons-outlined" aria-hidden="true">settings</span>
            </button>
            <div id="chord-settings-menu" class="chord-settings-menu" role="menu" aria-hidden="true">
                <div class="chord-settings-row is-disabled" id="max-per-row-row">
                    <label for="max-per-row-checkbox" class="chord-settings-label">
                        <input type="checkbox" id="max-per-row-checkbox">
                        <span>Limit chords per row</span>
                    </label>
                    <div class="chord-settings-value">
                        <label for="max-per-row-input" class="chord-settings-input-label">Max</label>
                        <input type="number" id="max-per-row-input" inputmode="numeric" min="1" max="24" value="8"
                            aria-label="Max chords per row" disabled>
                    </div>
                </div>

                <div class="chord-settings-row" id="five-frets-row">
                    <label for="five-frets-checkbox" class="chord-settings-label">
                        <input type="checkbox" id="five-frets-checkbox">
                        <span>Show 5 frets</span>
                    </label>
                </div>

                <div class="chord-settings-row" id="show-intervals-row">
                    <label for="show-intervals-checkbox" class="chord-settings-label">
                        <input type="checkbox" id="show-intervals-checkbox">
                        <span>Show intervals</span>
                    </label>
                </div>
            </div>

        </div>
    </div>

</div>

{% if groups|length == 0 %}

<p id="empty-msg">No chords defined yet.</p> {% else %} <p id="empty-msg" style="display:none;">No chords defined yet.
</p> {% endif %}

<div id="import-chords-area" style="display: none; margin-bottom: 1rem;">
    <div style="font-size: 14px!important; margin-top: 0!important; margin-bottom: 0 !important;">
        <label for="import-chords-input" class="form-label">
            <code style="color: #0d6efd;">Add one chord per line, like this :</code>
            <code style="padding-left:1em;">Am, x02210</code>
    </div>
    <div
        style="font-size: 1rem!important; margin-top: 0!important; margin-bottom: 0 !important; transform: translateY(-0.5em) !important;">
        <code style="color: #0d6efd;">Optionally, include the group name:</code>
        <code style="padding-left:1em;">Am, x02210, Group Name</code>
        </label>
    </div>
    <textarea id="import-chords-input" class="form-control mb-2" rows="5"
        style="resize: vertical; min-height: 5em; max-height: 15em;"></textarea>
    <div>
        <button id="import-chords-btn" class="btn btn-primary btn-sm">Import</button>
        <button id="cancel-import-chords" class="btn btn-outline-secondary btn-sm">Cancel</button>
    </div>
</div>

<div id="groups-root">
    {% for group in groups %}
    <div class="group mb-4">
        <div class="group-header mb-2">
            <div class="group-title-area">
                <span class="material-icons-outlined group-handle">drag_indicator</span>
                <input class="form-control form-control-sm group-name" value="{{ group.group }}">
            </div>

            <div class="group-buttons">
                <button type="button" class="add-chord" aria-label="Add chord" data-tooltip="Add Chord"
                    title="Add Chord">
                    <span class="material-icons-outlined">add_circle</span>
                </button>
                <button type="button" class="delete-chords" aria-label="Delete chords" data-tooltip="Delete Chords"
                    title="Delete Chords">
                    <span class="material-icons-outlined">remove_circle_outline</span>
                </button>
            </div>
        </div>



        {% set row_list = group.rows or [] %}
        {% if row_list|length == 0 %}
        {% set row_list = [{'chords': []}] %}
        {% endif %}
        {% for row in row_list %}
        <div class="d-grid chord-grid" data-row-index="{{ loop.index0 }}" data-sortable="1">
            <span class="row-drag-handle material-icons-outlined" aria-hidden="true">drag_indicator</span>
            {% for chord in row.chords or [] %}
            {% set diag = chord.diagram %}
            <div class="text-center chord-card mb-3" data-raw-name='{{ chord.name|tojson }}'>
                <div class="d-flex align-items-center justify-content-between mb-1 position-relative">
                    <span class="material-icons-outlined chord-handle">drag_indicator</span>
                    <span class="chord-title flex-grow-1 text-truncate mx-1">{{ chord.name }}</span>
                    <span class="material-icons-outlined chord-edit"
                        style="cursor: pointer; font-size: 18px;">edit</span>
                    <button class="delete-chord-btn" type="button" title="Delete chord" tabindex="-1"
                        style="display:none;">&#8722;</button>
                </div>

                <table class="chord-diagram">
                    <thead>
                        <tr>
                            <th class="chord-header-spacer"></th>
                            {% for x in diag.header %}
                            {# positional class for nut clipping #}
                            {% set pos_class = 'string-col' %}
                            {% if loop.first %}
                            {% set pos_class = pos_class + ' string-left' %}
                            {% elif loop.last %}
                            {% set pos_class = pos_class + ' string-right' %}
                            {% endif %}

                            {# visual class based on symbol #}
                            {% if x in ['x', 'X'] %}
                            {% set cls = 'chord-header-muted ' + pos_class %}
                            {% elif x in ['o', 'O'] %}
                            {% set cls = 'chord-header-open ' + pos_class %}
                            {% else %}
                            {% set cls = 'chord-header-fret ' + pos_class %}
                            {% endif %}

                            <th class="{{ cls }}">
                                {% if x in ['x', 'X', 'o', 'O'] %}
                                <span class="chord-header-label">{{ x }}</span>
                                {% endif %}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in diag.rows %}
                        <tr>
                            <td class="chord-fret-label">{{ row.fret }}</td>
                            {% for mark in row.strings %}
                            <td
                                class="chord-string-cell{% if loop.first %} string-left{% elif loop.last %} string-right{% endif %}">
                                <div class="chord-dot-wrap">
                                    <div class="chord-dot {{ 'chord-dot-filled' if mark == 1 }}"></div>
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                        <!-- Fretted numbers below diagram -->
                        <tr class="chord-footer-row">
                            <td class="chord-footer-spacer"></td>
                            {% for x in diag.header %}
                            <td class="chord-footer-cell">
                                {% if x not in ['x', 'X', 'o', 'O'] %}
                                <span class="chord-footer-label">{{ x }}</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>

                <div class="chord-edit-section">
                    <div class="chord-edit-fields mb-2">
                        <textarea class="form-control form-control-sm mb-1 chord-name-input"
                            rows="2">{{ chord.name }}</textarea>
                        <input class="form-control form-control-sm chord-shape-input" value="{{ chord.shape }}">
                    </div>
                    <div class="chord-symbols-toolbar"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <div class="group-footer-actions">
            <button type="button" class="export-group" aria-label="Export this group to file"
                data-tooltip="Export this Group to File" data-tooltip-src="Export this Group to File"
                title="Export this Group to File">
                <span class="material-icons-outlined">file_download</span>
            </button>
        </div>
    </div>
    {% endfor %}

</div>

<script src="{{ url_for('static', filename='vendor/morphdom-umd.min.js') }}"></script>
<script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script defer src="{{ url_for('static', filename='vendor/micromodal.min.js') }}"></script>
<script defer src="{{ url_for('static', filename='tooltips.js') }}"></script>
<script defer src="{{ url_for('static', filename='undoRedo.js') }}"></script>
<script defer src="{{ url_for('static', filename='chordDiagram.js') }}"></script>
<script defer src="{{ url_for('static', filename='vendor/tonal.min.js') }}"></script>
<script>
    window.MCL_DICT_BUST = "{{ app_start_ts }}";
</script>
<script defer src="{{ url_for('static', filename='chordNaming.js') }}"></script>
<script>
    {% if collection_id is defined %}
    window.MY_CHORDS_EDIT_URL = "{{ url_for('collection_chords_edit', collection_id=collection_id) }}";
    {% endif %}
</script>
<script defer src="{{ url_for('static', filename='my-chords.page.js') }}"></script>

{% endblock %}

{% block modals %}
<!-- Base Fret Modal -->
<div class="modal micromodal-slide" id="base-fret-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container base-fret-modal-container base-fret-modal-box" role="dialog" aria-modal="true"
            aria-labelledby="base-fret-modal-title">

            <button type="button" class="modal__close-button" aria-label="Close modal"
                data-micromodal-close>&times;</button>
            <div class="base-fret-modal-content">
                <div id="base-fret-modal-title">Pick base fret</div>
                <div id="base-fret-modal-hint">Type a number from 1 to 24, then press Enter. Esc cancels.</div>
                <input id="base-fret-modal-value" class="base-fret-input" type="text" aria-label="Base fret"
                    autocomplete="off" inputmode="numeric" pattern="[0-9]*" aria-live="polite" />
            </div>

        </div>
    </div>
</div>

<!-- Delete Group Modal -->
<div class="modal micromodal-slide" id="delete-group-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container delete-group-modal-container" role="dialog" aria-modal="true"
            aria-labelledby="delete-group-modal-title">

            <h5 id="delete-group-modal-title" class="mb-3">This will delete the group and its chords.<br>
                Are you sure?</h5>
            <p>
            </p>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button id="confirm-delete-group" class="btn btn-danger btn-sm"><span class="modal-button-text">Yes,
                        delete group</span></button>
                <button id="cancel-delete-group" class="btn btn-secondary btn-sm" aria-label="Cancel delete"
                    data-micromodal-close>Cancel</button>
            </div>

        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal micromodal-slide" id="help-modal" aria-hidden="true">
    <div class="modal__overlay modaloverlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container help-modal-container modalcontainer" role="dialog" aria-modal="true"
            aria-labelledby="help-modal-title">
            <div class="modal__header modalheader">
                <h3 id="help-modal-title" class="modal__title modaltitle help-modal-title">Help</h3>
                <button type="button" class="modal__close-button modal__close modalclose" aria-label="Close help modal"
                    data-micromodal-close>&times;</button>
            </div>
            <div class="modal__content modalcontent help-modal-content">
                <div class="help-section">
                    <div class="help-section-title">Keyboard Shortcuts</div>
                    <ul class="help-section-list">
                        <li>Alt+A: Add chord</li>
                        <li>Alt+D: Delete chords or groups</li>
                        <li>Ctrl+Z: Undo</li>
                        <li>Ctrl+Shift+Z: Redo</li>
                        <li>Alt+L: Toggle lock to prevent edits</li>
                        <li>Control+/: Show help page</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title">Moving Items</div>
                    <ul class="help-section-list">
                        <li>Drag handle icons ⋮⋮</li>
                        <li>Groups: Hover over group title ⋮⋮</li>
                        <li>Rows: Hover over first chord in row ⋮⋮</li>
                        <li>Chords: Hover over any chord card ⋮⋮</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title">Adding and Deleting Items</div>
                    <ul class="help-section-list">
                        <li>Add or delete chords: Use shortcuts or the + and − buttons in the group upper right</li>
                        <li>Add group: Hover over the top or bottom edge of a group, then click the green +</li>
                        <li>Add row: Hover below the last row of a group, then click the blue +</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title">Editing Titles</div>
                    <ul class="help-section-list">
                        <li>Click titles to edit directly</li>
                        <li>Tooltips: Text in {curly braces} shows on hover</li>
                        <li>Text-only cards: "Wrap titles in quotes" to create text only cards. Use Shift+Enter to add
                            line
                            breaks.</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title">Editing Chord Diagrams</div>
                    <ul class="help-section-list">
                        <li>Edit directly when unlocked</li>
                        <li>Ctrl+Click chord diagram: Enter/Exit Edit Mode</li>
                        <li>Ctrl+Enter: Exit Edit Mode and save</li>
                        <li>Esc: Exit Edit Mode without saving</li>
                        <li>Left Click fret: Add or remove notes</li>
                        <li>Shift+Click fret: Set Root or Ghost Root (a ghost root is displayed but not supposed to be
                            played)</li>
                        <li>Alt+Click String: Assign X (mute)</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-section-title">Import and Export</div>
                    <ul class="help-section-list">
                        <li>Click the 'Import Chords' button to batch import text, with one chord per line, for example
                            'Am, X02210'</li>
                        <li>Blank lines in the import text start a new row in that group</li>
                        <li>Import or export JSON with Import Chords from File</li>
                        <li>Export a single group to file using the button at the group bottom right.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Chord Edit Spotlight Modal -->
<div class="modal micromodal-slide" id="chord-edit-modal" aria-hidden="true">
    <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container chord-edit-modal-container" role="dialog" aria-modal="true"
            aria-labelledby="chord-edit-modal-title">

            <button type="button" class="modal__close-button" aria-label="Close edit modal"
                data-micromodal-close>&times;</button>


            <!-- The currently edited chord card will be moved into this slot -->
            <div class="chord-edit-modal-slot"></div>

        </div>
    </div>
</div>
{% endblock %}
